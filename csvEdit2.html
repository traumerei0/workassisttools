<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CSV編集ツール</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f3f4f6;
      margin:0;
      padding:20px;
      color:#111827;
    }
    h1, h2 {
      margin-top:0;
    }
    .container {
      max-width:900px;
      margin:0 auto;
      background:#ffffff;
      border-radius:8px;
      padding:16px 20px 24px;
      box-shadow:0 2px 6px rgba(0,0,0,0.06);
    }
    .flex {
      display:flex;
      gap:16px;
      flex-wrap:wrap;
    }
    .textarea-block {
      flex:1 1 300px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .label-row {
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:space-between;
    }
    label {
      font-size:14px;
      font-weight:600;
    }
    textarea {
      width:100%;
      box-sizing:border-box;
      padding:8px;
      border-radius:4px;
      border:1px solid #d1d5db;
      font-family:monospace;
      resize:vertical;
      background:#f9fafb;
    }
    button {
      border:none;
      border-radius:4px;
      padding:8px 12px;
      font-size:14px;
      cursor:pointer;
      background:#2563eb;
      color:white;
    }
    button:hover {
      background:#1d4ed8;
    }
    .paste-btn {
      padding:4px 8px;
      font-size:11px;
      background:#6b7280;
    }
    .paste-btn:hover {
      background:#4b5563;
    }
    #processBtn {
      margin-top:12px;
    }
    .error {
      margin-top:8px;
      color:#b91c1c;
      font-size:13px;
    }
    .message {
      margin-top:8px;
      color:#047857;
      font-size:13px;
    }

    /* 編集モードのカードレイアウト */
    #editList {
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .row-card {
      border:1px solid #e5e7eb;
      border-radius:6px;
      padding:8px 10px 10px;
      background:#f9fafb;
    }
    .row-header {
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:4px;
    }
    .company-name {
      font-weight:600;
      cursor:pointer;
      text-decoration:underline;
      text-decoration-style:dotted;
    }
    .company-name:hover {
      text-decoration-style:solid;
    }
    .hp-line {
      font-size:12px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
    .hp-label {
      color:#2563eb;
      text-decoration:underline;
      cursor:pointer;
      font-weight:600;
    }

    .row-fields {
      margin-top:4px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .field-line {
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
    }
    .field-label {
      font-size:12px;
      color:#6b7280;
      min-width:7em;
    }
    .field-label.search-link {
      color:#2563eb;
      text-decoration:underline;
      cursor:pointer;
      font-weight:600;
    }
    .field-input {
      padding:4px 6px;
      font-size:12px;
      border-radius:4px;
      border:1px solid #d1d5db;
      box-sizing:border-box;
      width:220px;      /* 全入力欄を短めに固定 */
      max-width:100%;
      flex:0 0 220px;
    }
    .move-btn {
      padding:2px 6px;
      font-size:10px;
      background:#e5e7eb;
      color:#374151;
    }
    .move-btn:hover {
      background:#d1d5db;
    }

    #exportBtn {
      margin-top:12px;
    }
    #exportOutput {
      margin-top:8px;
      font-size:12px;
      background:#f9fafb;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>CSV編集ツール</h1>

  <!-- インポートエリア -->
  <div id="import-section" style="display: block;">
    <div class="flex">
      <div class="textarea-block">
        <div class="label-row">
          <label for="namesInput">A欄（会社名 / 1行1社・最大約50行想定）</label>
          <button type="button" class="paste-btn" data-target="namesInput">ペースト</button>
        </div>
        <textarea id="namesInput" rows="18" placeholder="会社名1
会社名2
会社名3
..."></textarea>
      </div>
      <div class="textarea-block">
        <div class="label-row">
          <label for="csvInput">B欄（CSV / 1行1社）</label>
          <button type="button" class="paste-btn" data-target="csvInput">ペースト</button>
        </div>
        <textarea id="csvInput" rows="18" placeholder="会社HP,メールアドレス,インスタアカウントURL,FacebookURL,その他SNSアカウント,問い合わせフォームURL,電話番号,住所,従業員数,業務内容
..."></textarea>
      </div>
    </div>
    <button id="processBtn">処理して編集モードへ</button>
    <div id="error" class="error"></div>
  </div>

  <!-- 編集エリア -->
  <div id="edit-section" style="display: none;">
    <h2>CSV編集モード（全件表示）</h2>

    <div id="editList"></div>

    <button id="exportBtn">エクスポートしてクリップボードにコピー</button>
    <div class="textarea-block">
      <label for="exportOutput">エクスポート結果（B欄形式のCSV全行）</label>
      <textarea id="exportOutput" rows="10" readonly></textarea>
    </div>
    <div id="exportMessage" class="message"></div>
  </div>
</div>

<script>
(() => {
  const namesInput    = document.getElementById('namesInput');
  const csvInput      = document.getElementById('csvInput');
  const processBtn    = document.getElementById('processBtn');
  const importSection = document.getElementById('import-section');
  const editSection   = document.getElementById('edit-section');
  const errorBox      = document.getElementById('error');
  const editList      = document.getElementById('editList');
  const exportBtn     = document.getElementById('exportBtn');
  const exportOutput  = document.getElementById('exportOutput');
  const exportMessage = document.getElementById('exportMessage');

  // rows[i] = [会社名, 会社HP, メールアドレス, インスタ, Facebook, その他SNS, 問い合わせフォームURL, 電話番号, 住所, 従業員数, 業務内容]
  let rows = [];

  const colMeta = [
    { index: 1,  label: '会社HP',               editable: true  },
    { index: 2,  label: 'メールアドレス',       editable: true  },
    { index: 3,  label: 'インスタアカウントURL', editable: true },
    { index: 4,  label: 'FacebookURL',          editable: true  },
    { index: 5,  label: 'その他SNSアカウント',   editable: true },
    { index: 6,  label: '問い合わせフォームURL', editable: true  },
    { index: 7,  label: '電話番号',             editable: true  },
    { index: 8,  label: '住所',                 editable: true  },
    { index: 9,  label: '従業員数',             editable: true  },
    { index: 10, label: '業務内容',             editable: true  }
  ];

  function cleanValue(v) {
    if (v == null) return '';
    v = v.trim();
    if (v === '' || v === '""') return '';
    if (v.length >= 2 && v.startsWith('"') && v.endsWith('"')) {
      v = v.slice(1, -1);
    }
    return v.trim();
  }

  function copyToClipboard(text) {
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).catch(() => {});
    } else {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
  }

  async function pasteTo(targetId) {
    const el = document.getElementById(targetId);
    if (!el) return;
    if (!navigator.clipboard || !navigator.clipboard.readText) {
      alert('クリップボードの読み取りに対応していないブラウザの可能性があるよ。');
      return;
    }
    try {
      const text = await navigator.clipboard.readText();
      el.value = text;
    } catch (e) {
      alert('クリップボードからの貼り付けに失敗したかも。ブラウザの許可設定を確認してね。');
    }
  }

  document.querySelectorAll('.paste-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      if (target) pasteTo(target);
    });
  });

  processBtn.addEventListener('click', () => {
    errorBox.textContent = '';
    rows = [];
    editList.innerHTML = '';

    const nameLines = namesInput.value
      .split(/\r?\n/)
      .map(l => l.trim())
      .filter(l => l !== '');

    const csvLines = csvInput.value
      .split(/\r?\n/)
      .map(l => l.trim())
      .filter(l => l !== '');

    if (nameLines.length === 0 || csvLines.length === 0) {
      errorBox.textContent = 'A欄・B欄の両方にデータを入れてね。';
      return;
    }

    if (nameLines.length !== csvLines.length) {
      errorBox.textContent = `行数が合いません（会社名: ${nameLines.length}行 / CSV: ${csvLines.length}行）。`;
      return;
    }

    for (let i = 0; i < csvLines.length; i++) {
      const line = csvLines[i];
      const rawCols = line.split(',');
      const cols = rawCols.map(cleanValue);

      while (cols.length < 10) {
        cols.push('');
      }

      const row = [nameLines[i], ...cols];
      rows.push(row);
    }

    renderEditList();
    importSection.style.display = 'none';
    editSection.style.display = 'block';
  });

  function moveValue(index, col, delta) {
    const targetCol = col + delta;
    if (targetCol < 1 || targetCol > 10) return;

    const srcVal = rows[index][col] || '';
    if (!srcVal) return;

    rows[index][col] = '';
    rows[index][targetCol] = srcVal;

    const srcInput = document.querySelector(
      '.field-input[data-index="' + index + '"][data-col="' + col + '"]'
    );
    const destInput = document.querySelector(
      '.field-input[data-index="' + index + '"][data-col="' + targetCol + '"]'
    );

    if (srcInput) srcInput.value = '';
    if (destInput) destInput.value = srcVal;
  }

  function addMoveButtons(wrapper, inputEl) {
    const upBtn = document.createElement('button');
    upBtn.type = 'button';
    upBtn.textContent = '↑';
    upBtn.className = 'move-btn';
    upBtn.addEventListener('click', () => {
      const idx = Number(inputEl.dataset.index);
      const col = Number(inputEl.dataset.col);
      if (!Number.isFinite(idx) || !Number.isFinite(col)) return;
      moveValue(idx, col, -1);
    });

    const downBtn = document.createElement('button');
    downBtn.type = 'button';
    downBtn.textContent = '↓';
    downBtn.className = 'move-btn';
    downBtn.addEventListener('click', () => {
      const idx = Number(inputEl.dataset.index);
      const col = Number(inputEl.dataset.col);
      if (!Number.isFinite(idx) || !Number.isFinite(col)) return;
      moveValue(idx, col, +1);
    });

    wrapper.appendChild(upBtn);
    wrapper.appendChild(downBtn);
  }

  function renderEditList() {
    editList.innerHTML = '';

    rows.forEach((row, index) => {
      const name = row[0] || '';
      const hp   = row[1] || '';

      const card = document.createElement('div');
      card.className = 'row-card';
      card.dataset.index = index;

      const header = document.createElement('div');
      header.className = 'row-header';

      const nameSpan = document.createElement('span');
      nameSpan.className = 'company-name';
      nameSpan.textContent = name || '(会社名なし)';
      nameSpan.addEventListener('click', () => {
        const q = encodeURIComponent(name);
        const url = `https://www.google.com/search?q=${q}`;
        window.open(url, '_blank');
      });
      header.appendChild(nameSpan);

      const hpLine = document.createElement('div');
      hpLine.className = 'hp-line';

      const hpLabel = document.createElement('span');
      hpLabel.className = 'hp-label';
      hpLabel.textContent = '会社HP';
      hpLine.appendChild(hpLabel);

      const hpInput = document.createElement('input');
      hpInput.type = 'text';
      hpInput.className = 'field-input';
      hpInput.value = hp;
      hpInput.placeholder = '公式サイトURL';
      hpInput.dataset.index = index.toString();
      hpInput.dataset.col = '1';
      hpLine.appendChild(hpInput);

      // 会社HPラベルクリックでURL遷移
      hpLabel.addEventListener('click', () => {
        const val = (hpInput.value || '').trim();
        if (!val) return;
        const url = val.startsWith('http') ? val : 'https://' + val;
        window.open(url, '_blank');
      });

      // HP入力欄にも↑↓ボタン
      addMoveButtons(hpLine, hpInput);

      header.appendChild(hpLine);
      card.appendChild(header);

      const fields = document.createElement('div');
      fields.className = 'row-fields';

      colMeta.forEach(meta => {
        if (meta.index === 1) return; // 1列目（会社HP）は上で処理済み

        const line = document.createElement('div');
        line.className = 'field-line';

        const label = document.createElement('span');
        label.className = 'field-label';
        label.textContent = meta.label;

        // 電話番号・住所はクリックでGoogle検索
        if (meta.label === '電話番号' || meta.label === '住所') {
          label.classList.add('search-link');
          label.addEventListener('click', () => {
            const company = rows[index][0] || '';
            if (!company) return;
            const suffix = meta.label === '電話番号' ? ' 電話番号' : ' 住所';
            const q = encodeURIComponent(company + suffix);
            const url = 'https://www.google.com/search?q=' + q;
            window.open(url, '_blank');
          });
        }

        line.appendChild(label);

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'field-input';
        input.value = row[meta.index] || '';
        input.dataset.index = index.toString();
        input.dataset.col = meta.index.toString();

        line.appendChild(input);

        // 各入力欄に↑↓ボタン
        addMoveButtons(line, input);

        fields.appendChild(line);
      });

      card.appendChild(fields);
      editList.appendChild(card);
    });
  }

  exportBtn.addEventListener('click', () => {
    exportMessage.textContent = '';

    const inputs = document.querySelectorAll('.field-input');
    inputs.forEach(input => {
      const idx = Number(input.dataset.index);
      const col = Number(input.dataset.col);
      if (!Number.isFinite(idx) || !Number.isFinite(col)) return;
      const val = input.value.trim();
      rows[idx][col] = val;
    });

    const resultLines = rows.map(row => {
      const outCols = [];
      for (let col = 1; col <= 10; col++) {
        outCols.push(row[col] || '');
      }
      return outCols.join(',');
    });
    const resultText = resultLines.join('\n');

    exportOutput.value = resultText;
    copyToClipboard(resultText);
    exportMessage.textContent = 'B欄形式のCSV全行をクリップボードにコピーしたよ。';
  });
})();
</script>

</body>
</html>
